<!DOCTYPE html>
<html>
<head>
    <title>记录详情</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css">

    <style type="text/css">
        @import url("css/comon.css");
    </style>
    <title>
        <h3 class="demos-title">访问</h3>
    </title>

</head>

<body ontouchstart>
<div id="dataDetail"></div>
<!--<div class="weui-media-box weui-media-box_appmsg">
    <div class="weui-media-box__hd"></div>
    <div class="weui-media-box__bd">

        <p class="weui-cell__bd">&nbsp;&nbsp;&nbsp;发起人&nbsp;&nbsp;&nbsp; 本人</p><br>
        <p class="weui-cell__bd">&nbsp;&nbsp;&nbsp;受访人&nbsp;&nbsp;&nbsp; 李思思</p><br>
        <p class="weui-cell__bd">申请时间&nbsp;&nbsp;&nbsp; 2019-12-01 17:06</p><br>
        <p class="weui-cell__bd">受理时间&nbsp;&nbsp;&nbsp; 2019-12-01 18:27</p><br>
        <p class="weui-cell__bd">受理状态&nbsp;&nbsp;&nbsp; <font color="#006400">通过</font></p><br>
        <p class="weui-cell__bd">访问时间&nbsp;&nbsp;&nbsp; 2019-12-03 15:30-18:00</p><br>
        <p class="weui-cell__bd">访问地址&nbsp;&nbsp;&nbsp; 福州市IFC</p><br>
    </div>

</div>-->


<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>
<script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.js"></script>
<script src="js/myUtil.js"></script>
<script>
    var recordId;
    var companyId = -1;
    $(function () {

        var detail = window.localStorage.getItem("detailRecord");
        var detailJson = JSON.parse(detail)
        recordId = detailJson.id;
        console.log("========================")
        console.log(detailJson)
        var userName = "";
        var visitorName = "";

        if (detailJson.recordType == '1') {
            if (getCookie("userId") == detailJson.userId) {
                console.log(userName + "1," + visitorName);
                userName = "本人"
                visitorName = detailJson.realName;
                console.log(userName + "," + visitorName);
            } else {
                console.log(userName + "2," + visitorName);
                userName = detailJson.realName;
                visitorName = "本人";
                console.log(userName + "," + visitorName);
            }

        } else {
            if (getCookie("userId") == detailJson.userId) {
                console.log(userName + "3," + visitorName);
                userName = detailJson.realName;
                visitorName = "本人";
                console.log(userName + "," + visitorName);
            } else {
                console.log(userName + "4," + visitorName);
                userName = "本人"
                visitorName = detailJson.realName;
                console.log(userName + "," + visitorName);
            }

        }
        //申请时间
        var applyDate = detailJson.visitDate + " " + detailJson.visitTime;
        //受理时间
        var replyDate = detailJson.replyDate + " " + detailJson.replyTime;
        //访问时间
        var date = detailJson.startDate.substring(0, 10);
        var startTime = detailJson.startDate.substring(11, 16);
        var endTime = detailJson.endDate.substring(11, 16);
        var visitDate = date + " " + startTime + "-" + endTime;
        //记录状态
        var status = "";
        //show=1 界面为详情数据，show=0 界面为审核界面
        var show = 1;
        if (detailJson.vstatus == "access") {
            status = "<font color=\"#006400\">通过</font>";
            show = 1;
        } else if (detailJson.vstatus == "refuse") {
            status = "<font color=\"#8b0000\">拒绝</font>";
            show = 1;
        } else if (detailJson.vstatus == "unaudited") {
            status = "<font color=\"blue\">待审核</font>";
            show = 0;
        } else if (detailJson.vstatus == "expired") {
            status = "<font color=\"#696969\">过期</font>";
            show = 1;
        } else {
            status = "未知状态";
            show = 1;
        }
        var peopleType = "";
        if(detailJson.recordType != "1"){
            peopleType ="受邀人"
        }else{
            peopleType ="受访人"
        }
        if (show == 1) {
            $("#dataDetail").append("<div class=\"weui-media-box weui-media-box_appmsg\">\n" +
                "    <div class=\"weui-media-box__hd\"></div>\n" +
                "    <div class=\"weui-media-box__bd\">\n" +
                "\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">&nbsp;&nbsp;&nbsp;发起人&nbsp;&nbsp;&nbsp; " + userName + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">&nbsp;&nbsp;&nbsp;"+peopleType+"&nbsp;&nbsp;&nbsp; " + visitorName + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">申请时间&nbsp;&nbsp;&nbsp; " + applyDate + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">受理时间&nbsp;&nbsp;&nbsp; " + replyDate + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">受理状态&nbsp;&nbsp;&nbsp; " + status + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">访问时间&nbsp;&nbsp;&nbsp; " + visitDate + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">访问地址&nbsp;&nbsp;&nbsp; " + detailJson.companyName + "</p><br>\n" +
                "    </div>\n" +
                "</div>")
        } else if (show == 0) {
            $("#dataDetail").append("<div class=\"weui-media-box weui-media-box_appmsg\">\n" +
                "    <div class=\"weui-media-box__hd\"></div>\n" +
                "    <div class=\"weui-media-box__bd\">\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">&nbsp;&nbsp;&nbsp;发起人&nbsp;&nbsp;&nbsp; " + userName + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">&nbsp;&nbsp;&nbsp;受访人&nbsp;&nbsp;&nbsp; " + visitorName + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">申请时间&nbsp;&nbsp;&nbsp; " + applyDate + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">受理状态&nbsp;&nbsp;&nbsp; " + status + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">访问时间&nbsp;&nbsp;&nbsp; " + visitDate + "</p><br>\n" +
                "       <p style=\"display: block\" id=\"addrshow\"></p> \n" +
                "    </div>\n" +
                "</div>")
            if (detailJson.recordType == "1") {
                if (getCookie("userId") == detailJson.userId) {
                    document.getElementById("addrshow").style.display = 'none';
                } else {
                    $("#addrshow").append("<label for=\"address\" style='margin-left: 5%'>请选择您的会面地址</label><br><br>\n" +
                        "                    <p><input class=\"weui-input\" id=\"address\" type=\"text\" style='margin-left: 5%'></p><br>")
                }
            }else{
                companyId = detailJson.companyId;
                $("#addrshow").append("<p class=\"weui-cell__bd\" style=\"margin-left: 5%\">访问地址&nbsp;&nbsp;&nbsp; " + detailJson.companyName + "</p><br>")
            }
           /* if (getCookie("userId") == detailJson.userId && detailJson.recordType == "1") {
                document.getElementById("addrshow").style.display = 'none';
            }*/
        }
        getCompany();
        var identify = detailJson.recordType;
        var btnshow = "F";
        if (identify == "1" && getCookie("userId") == detailJson.visitorId) {
            btnshow = "T";
        } else if (identify == "2" && getCookie("userId") == detailJson.userId) {
            btnshow = "T";
        } else {
            btnshow = "F";
        }
        if (detailJson.vstatus == "unaudited" && btnshow == "T") {
            $("#dataDetail").append("<div>\n" +
                "    <a href=\"javascript:;\" class=\"weui-btn weui-btn_primary\" onclick=\"verify('applySuccess')\">通过</a>\n" +
                "    <a href=\"javascript:;\" class=\"weui-btn weui-btn_warn\" onclick=\"verify('applyFail')\">拒绝</a>\n" +
                "</div>")
        }
    })

    function verify(status) {
        if (companyId == -1 && status == "applySuccess") {
            $.toptip("请选择会面地址");
            return;
        } else {
            $.ajax({
                type: 'POST',
                contentType: "application/x-www-form-urlencoded",
                url: "visit/record/confireRecord",
                data: {
                    recordId: recordId,
                    cstatus: status,
                    companyId: companyId
                },
                success: function (result) {
                    console.log(result)
                    $.toptip("审核成功", "success");
                    window.location.href = secondRecordUrl;
                },
                //请求失败，包含具体的错误信息
                error: function (e) {
                    $.hideLoading();
                    $.toptip(e.message);
                }
            });
        }

    }

    //公司获取
    function getCompany() {

        $.ajax({
            type: 'POST',
            contentType: "application/x-www-form-urlencoded",
            url: "/pybl/company/findByUserId",
            data: {userId: getCookie("userId")},
            success: function (result) {
                console.log(result)
                var companys = [];
                for (var i in result.data) {
                    companys.push(result.data[i].companyname)
                }
                $("#address").picker({
                    title: "请选择地址",
                    cols: [
                        {
                            textAlign: 'center',
                            values: companys,
                        }
                    ],
                    onChange: function (p, v, dv) {
                        console.log();
                    },
                    onClose: function (p, v, d) {
                        var companyName = $("#address").val()//店铺名赋值

                        for (var i in result.data) {
                            if (result.data[i].companyname == companyName) {
                                companyId = result.data[i].id;
                                console.log(companyId)
                            }
                        }
                    }
                });
            }
        });
    }
</script>
</body>
</html>
