<!DOCTYPE html>
<html>
<head>
    <title>记录详情</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css">

    <title>
        <h3 class="demos-title">访问</h3>
    </title>

</head>

<body ontouchstart>
<div id="dataDetail" style="display: none"></div>

<div class="weui-form-preview"  style="margin-left: 3%;margin-right: 3%;margin-top: 3%">
    <div class="weui-form-preview__hd" style="padding-top: 5%">
        <label class="weui-form-preview__label"><font id="visitType1">访问人</font></label>
        <em class="weui-form-preview__value"><font size="3" id="userName">林先生</font></em>
        <label class="weui-form-preview__label"><font id="visitType2">被访者</font></label>
        <em class="weui-form-preview__value"><font size="3" id="visitorName">陈先生</font></em>
    </div>
    <div class="weui-form-preview__bd">
        <div class="weui-form-preview__item">
            <label class="weui-form-preview__label">申请时间</label>
            <span class="weui-form-preview__value" id="applyDate">2020-05-22 16:01:02</span>
        </div>
        <div class="weui-form-preview__item" style="padding-top: 3px">
            <label class="weui-form-preview__label">申请状态</label>
            <span class="weui-form-preview__value"><font id="vstatus">过期</font></span>
        </div>
        <div class="weui-form-preview__item" id="appliedDateShow" style="padding-top: 3px">
            <label class="weui-form-preview__label">受理时间</label>
            <span class="weui-form-preview__value" id="appliedDate">2020-05-22 16:01-17:50</span>
        </div>
        <div class="weui-form-preview__item" style="padding-top: 3px">
            <label class="weui-form-preview__label">访问时间</label>
            <span class="weui-form-preview__value" id="visitDate">2020-05-22 16:01-17:50</span>
        </div>
        <div class="weui-form-preview__item" style="padding-top: 3px">
            <label class="weui-form-preview__label" >事由</label>
            <span class="weui-form-preview__value" id="reason"></span>
        </div>
        <div class="weui-form-preview__item" id="appliedAddrShow" style="padding-top: 3px">
            <label class="weui-form-preview__label">访问地址</label>
            <span class="weui-form-preview__value" id="appliedAddr">福州市软件园G区1号楼21层01办公室</span>
        </div>
        <div class="weui-form-preview__item" id="applyAddrShow" style="padding-top: 3px">
            <label class="weui-form-preview__label"><font color="red" size="4">*</font>地址选择</label>
            <span class="weui-form-preview__value"><input type="text" id='picker' placeholder="请选择会面地址"/></span>
        </div>
    </div>
    <div style="padding-top: 5%"></div>
    <div class="weui-form-preview__ft">
        <a class="weui-form-preview__btn weui-form-preview__btn_default" href="javascript:" id="refuse"><font color="red">拒绝</font></a>
        <button type="submit" class="weui-form-preview__btn weui-form-preview__btn_primary" href="javascript:" id="agree">同意</button>
    </div>
</div>


<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>
<script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.js"></script>
<script src="js/myUtil.js"></script>
<script>
    var recordId;
    var companyId = -1;
    $(function () {
        var detail = window.localStorage.getItem("detailRecord");
        var detailJson = JSON.parse(detail)
        recordId = detailJson.id;
        console.log("========================")
        console.log(detailJson)
        var userName = "";
        var visitorName = "";
        // replyStatus = 0 ：自己查看自己的申请，replyStatus = 1 ：对方查看自己的申请
        replyStatus = 0;
        if (detailJson.recordType == '1') {
            document.getElementById('visitType1').innerText = "访问人";
            document.getElementById('visitType2').innerText = "受访人";
            if (getCookie("userId") == detailJson.userId) {
                replyStatus =0 ;
                userName = "本人";
                visitorName = detailJson.realName;
            } else {
                replyStatus =1 ;
                userName = detailJson.realName;
                visitorName = "本人";
            }
        } else {
            document.getElementById('visitType1').innerText = "邀约人";
            document.getElementById('visitType2').innerText = "受邀人";
            if (getCookie("userId") == detailJson.userId) {
                replyStatus =0 ;
                userName = detailJson.realName;
                visitorName = "本人";
            } else {
                replyStatus =1 ;
                userName = "本人"
                visitorName = detailJson.realName;
            }
        }
        document.getElementById('userName').innerText = userName;
        document.getElementById('visitorName').innerText = visitorName;

        //申请时间
        var applyDate = detailJson.visitDate + " " + detailJson.visitTime;
        document.getElementById("applyDate").innerText = applyDate;
        document.getElementById("reason").innerText = detailJson.reason;
        //访问时间
        var date = detailJson.startDate.substring(0, 10);
        var startTime = detailJson.startDate.substring(11, 16);
        var endTime = detailJson.endDate.substring(11, 16);
        var visitDate = date + " " + startTime + "-" + endTime;
        document.getElementById("visitDate").innerText = visitDate;

        //show=1 界面为详情数据，show=0 界面为审核界面
        var show = 1;
        if (detailJson.vstatus == "access") {
            document.getElementById("vstatus").style.color = '#006400';
            document.getElementById("vstatus").innerText = "通过";
            show = 1;
        } else if (detailJson.vstatus == "refuse") {
            document.getElementById("vstatus").style.color = '#8b0000';
            document.getElementById("vstatus").innerText = "拒绝";
            show = 1;
        } else if (detailJson.vstatus == "unaudited") {
            document.getElementById("vstatus").style.color = 'blue';
            document.getElementById("vstatus").innerText = "待审核";
            show = 0;
        } else if (detailJson.vstatus == "expired") {
            document.getElementById("vstatus").style.color = '#696969';
            document.getElementById("vstatus").innerText = "过期";
            show = 1;
        } else {
            document.getElementById("vstatus").innerText = "未知状态";
            show = 1;
        }
        //详情页
        if (show == 1) {
            //受理时间
            var replyDate = detailJson.replyDate + " " + detailJson.replyTime;
            document.getElementById("appliedDateShow").style.display = 'block';
            document.getElementById("appliedDate").innerText = replyDate;
            document.getElementById("appliedAddrShow").style.display = 'block';
            document.getElementById("appliedAddr").innerText =detailJson.addr;
            document.getElementById("applyAddrShow").style.display = 'none';
            document.getElementById("refuse").style.display = 'none';
            document.getElementById("agree").style.display = 'none';
            document.getElementById("applying").style.display = 'none';
        } else if (show == 0) {
            document.getElementById("appliedDateShow").style.display = 'none';
            document.getElementById("appliedAddrShow").style.display = 'none';
            if(replyStatus == 0){
                document.getElementById("applyAddrShow").style.display = 'none';
                document.getElementById("refuse").style.display = 'none';
                document.getElementById("agree").style.display = 'none';
            }else{
                document.getElementById("applyAddrShow").style.display = 'block';
                document.getElementById("refuse").style.display = 'block';
                document.getElementById("agree").style.display = 'block';
            }
        }
        getCompany();
        var identify = detailJson.recordType;
        var btnshow = "F";
        if (identify == "1" && getCookie("userId") == detailJson.visitorId) {
            btnshow = "T";
        } else if (identify == "2" && getCookie("userId") == detailJson.userId) {
            btnshow = "T";
        } else {
            btnshow = "F";
        }
        if (detailJson.vstatus == "unaudited" && btnshow == "T") {
            $("#dataDetail").append("<div>\n" +
                "    <a href=\"javascript:;\" class=\"weui-btn weui-btn_primary\" onclick=\"verify('applySuccess')\">通过</a>\n" +
                "    <a href=\"javascript:;\" class=\"weui-btn weui-btn_warn\" onclick=\"verify('applyFail')\">拒绝</a>\n" +
                "</div>")
        }
    })

    function verify(status) {
        if (companyId == -1 && status == "applySuccess") {
            $.toptip("请选择会面地址");
            return;
        } else {
            $.ajax({
                type: 'POST',
                contentType: "application/x-www-form-urlencoded",
                url: "visit/record/confireRecord",
                data: {
                    recordId: recordId,
                    cstatus: status,
                    companyId: companyId
                },
                success: function (result) {
                    console.log(result)
                    $.toptip("审核成功", "success");
                    window.location.href = secondRecordUrl;
                },
                //请求失败，包含具体的错误信息
                error: function (e) {
                    $.hideLoading();
                    $.toptip("当前网络异常");
                }
            });
        }

    }

    //公司获取
    function getCompany() {

        $.ajax({
            type: 'POST',
            contentType: "application/x-www-form-urlencoded",
            url: "/pybl/company/findByUserId",
            data: {userId: getCookie("userId")},
            success: function (result) {
                console.log("===================")
                console.log(result)
                var companys = [];
                for (var i in result.data) {
                    companys.push(result.data[i].companyname + "(" + result.data[i].addr + ")")
                }
                $("#picker").picker({
                    title: "请选择地址",
                    cols: [
                        {
                            textAlign: 'center',
                            values: companys,
                        }
                    ]
                });
                $("#address").picker({
                    title: "请选择地址",
                    cols: [
                        {
                            textAlign: 'center',
                            values: companys,
                        }
                    ],
                    onChange: function (p, v, dv) {
                        console.log();
                    },
                    onClose: function (p, v, d) {
                        var companyName = $("#address").val()//店铺名赋值

                        for (var i in result.data) {
                            if (result.data[i].companyname + "(" + result.data[i].addr + ")"== companyName ) {
                                companyId = result.data[i].id;
                                console.log(companyId)
                            }
                        }
                    }
                });
            }
        });
    }
</script>
</body>
</html>
