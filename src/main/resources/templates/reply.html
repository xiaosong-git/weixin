<!DOCTYPE html>
<html>
<head>
    <title>记录详情</title>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport">
    <meta content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
" name="description">
    <link href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css" rel="stylesheet">

    <style type="text/css">
        @import url("css/comon.css");
    </style>
    <title>
        <h3 class="demos-title">访问邀约</h3>
    </title>

</head>

<body ontouchstart>
<div id="dataDetail"></div>


<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>
<script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<script src="js/myUtil.js"></script>
<script>
    var recordId;
    var companyId = -1;
    var recordType;
    var otherId;
    var realName;
    var visitDate;
    var applyDate;
    var cstatus;
    var isValue;
    var companyName;

    $(function () {

         recordId = getQueryString("recordId");
         otherId = getQueryString("otherId");
         console.log(recordId)
         getOtherUser();
         getRecord();


    });

    function verify(status) {
        if ((companyId == -1 && status == "applySuccess")||(isEmpty(companyId) && status == "applySuccess")) {
            $.toptip("请选择会面地址");
            return;
        } else {
            $.ajax({
                type: 'POST',
                contentType: "application/x-www-form-urlencoded",
                url: "visit/record/confireRecord",
                data: {
                    recordId: recordId,
                    cstatus: status,
                    companyId: companyId
                },
                success: function (result) {
                    console.log(result)
                    $.toptip("审核成功", "success");
                    $.toast("审核成功，页面即将关闭");
                    //点击确认后的回调函数
                    setTimeout(function () {
                        quit();
                    }, 1500);
                },
                //请求失败，包含具体的错误信息
                error: function (e) {
                    $.hideLoading();
                    $.toptip(e.message);
                }
            });
        }

    }

    //公司获取
    function getCompany() {
        $.ajax({
            type: 'POST',
            contentType: "application/x-www-form-urlencoded",
            url: "/pybl/company/findByUserId",
            data: {
                userId: getCookie("userId")
            },
            success: function (result) {
                console.log(result)
                var companys = [];
                for (var i in result.data) {
                    companys.push(result.data[i].companyname)
                }
                console.log("==========")
                console.log(companys)
                $("#address").picker({
                    title: "请选择地址",
                    cols: [
                        {
                            textAlign: 'center',
                            values: companys,
                        }
                    ],
                    onChange: function (p, v, dv) {
                        console.log();
                    },
                    onClose: function (p, v, d) {
                        var companyName = $("#address").val()//店铺名赋值

                        for (var i in result.data) {
                            if (result.data[i].companyname == companyName) {
                                companyId = result.data[i].id;
                                console.log(companyId)
                            }
                        }
                    }
                });
            }
        });
    }


    //退出
    function quit() {
        wx.closeWindow();
    }

    function getRecord() {
        console.log(recordId + "0=======")
        $.ajax({
            type: 'POST',
            contentType: "application/x-www-form-urlencoded",
            url: "visit/record/getRecord",
            data: {
                recordId: recordId
            },
            success: function (result) {
                if (result.code == 200) {
                    var data = result.data
                    if (data.userId != getCookie("userId")) {
                        otherId = data.userId;
                    } else {
                        otherId = data.visitorId;
                    }
                    recordType = data.recordType;
                    cstatus = data.cstatus;
                    applyDate = data.visitDate + " " + data.visitTime;
                    var date = data.startDate.substring(0, 10);
                    var startTime = data.startDate.substring(11, 16);
                    var endTime = data.endDate.substring(11, 16);
                    visitDate = date + " " + startTime + "-" + endTime;
                    isValue = data.isValue;
                    companyId = data.companyId;
                    companyName = data.companyName;
                    content();
                }
            }
        });
    }

    function getOtherUser() {
        $.ajax({
            type: 'POST',
            contentType: "application/x-www-form-urlencoded",
            url: "user/getUserById",
            data: {
                userId: otherId
            },
            success: function (result) {
                if (result.code == 200) {
                    realName = result.data.realname;
                }
            }
        });
    }
    function content() {
        var userName = "";
        var visitorName = "";

        if (recordType == '1') {
            userName = realName;
            visitorName = "本人";
        } else {
            visitorName = realName;
            userName = "本人";
        }

        //记录状态
        var status = "";
        //show=1 界面为详情数据，show=0 界面为审核界面
        var show = 1;
        console.log("isValue:"+isValue)
        if (isValue == "T") {
            if (cstatus == "applySuccess") {
                status = "<font color=\"#006400\">通过</font>";
                show = 1;
            } else if (cstatus == "applyFail") {
                status = "<font color=\"#8b0000\">拒绝</font>";
                show = 1;
            } else if (cstatus == "applyConfirm") {
                status = "<font color=\"blue\">待审核</font>";
                show = 0;
            }
        } else {
            status = "<font color=\"#696969\">过期</font>";
            show = 1;
        }
        var peopleType = "";
        if (recordType != "1") {
            peopleType = "受邀人"
        } else {
            peopleType = "受访人"
        }
        if (show == 1) {
            $("#dataDetail").append("<div class=\"weui-media-box weui-media-box_appmsg\">\n" +
                "    <div class=\"weui-media-box__hd\"></div>\n" +
                "    <div class=\"weui-media-box__bd\">\n" +
                "\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">&nbsp;&nbsp;&nbsp;发起人&nbsp;&nbsp;&nbsp; " + userName + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">&nbsp;&nbsp;&nbsp;" + peopleType + "&nbsp;&nbsp;&nbsp; " + visitorName + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">申请时间&nbsp;&nbsp;&nbsp; " + applyDate + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">受理状态&nbsp;&nbsp;&nbsp; " + status + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">访问时间&nbsp;&nbsp;&nbsp; " + visitDate + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">访问地址&nbsp;&nbsp;&nbsp; " + companyName + "</p><br>\n" +
                "    </div>\n" +
                "</div>")
        } else if (show == 0) {
            $("#dataDetail").append("<div class=\"weui-media-box weui-media-box_appmsg\">\n" +
                "    <div class=\"weui-media-box__hd\"></div>\n" +
                "    <div class=\"weui-media-box__bd\">\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">&nbsp;&nbsp;&nbsp;发起人&nbsp;&nbsp;&nbsp; " + userName + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">&nbsp;&nbsp;&nbsp;" + peopleType + "&nbsp;&nbsp;&nbsp; " + visitorName + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">申请时间&nbsp;&nbsp;&nbsp; " + applyDate + "</p><br>\n" +
                "        <p class=\"weui-cell__bd\" style=\"margin-left: 5%\">访问时间&nbsp;&nbsp;&nbsp; " + visitDate + "</p><br>\n" +
                "       <p style=\"display: block\" id=\"addrshow\"></p> \n" +
                "    </div>\n" +
                "</div>")
            if (recordType == "1") {

                $("#addrshow").append("<label for=\"address\" style='margin-left: 5%'>请选择您的会面地址</label><br><br>\n" +
                    "                    <p><input class=\"weui-input\" id=\"address\" type=\"text\" style='margin-left: 5%'></p><br>")
                getCompany();
            } else {
                companyId = companyId;
                $("#addrshow").append("<p class=\"weui-cell__bd\" style=\"margin-left: 5%\">访问地址&nbsp;&nbsp;&nbsp; " + companyName + "</p><br>")
            }
            if (cstatus == "applyConfirm" ) {
                $("#dataDetail").append("<div>\n" +
                    "    <a href=\"javascript:;\" class=\"weui-btn weui-btn_primary\" onclick=\"verify('applySuccess')\">通过</a>\n" +
                    "    <a href=\"javascript:;\" class=\"weui-btn weui-btn_warn\" onclick=\"verify('applyFail')\">拒绝</a>\n" +
                    "</div>")
            }
        }
    }

    //获取上个页面传过来的参数
    function getQueryString(name) {
        var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
        var r = window.location.search.substr(1).match(reg);
        if (r != null) {
            return unescape(r[2]);
        }
        return null;
    }
</script>
</body>
</html>
