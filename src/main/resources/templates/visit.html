<!DOCTYPE html>
<html>
<head>
    <title>发起访问</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css">
    <style type="text/css">
        @import url("css/comon.css");
    </style>
    <title>
        <h3 class="demos-title">访问</h3>
    </title>

</head>

<body ontouchstart>
<div class="weui-cells weui-cells_form">
    <div class="weui-cell">
        <div class="weui-cell__hd"><label class="weui-label">受访人姓名</label></div>
        <div class="weui-cell__bd">
            <input class="weui-input" id="visitorName" type="text" placeholder="请输入受访人姓名" onBlur="postNP()"
                   visitorId="">
        </div>
    </div>
    <div class="weui-cell">
        <div class="weui-cell__hd">
            <label class="weui-label">受访人手机号</label>
        </div>
        <div class="weui-cell__bd">
            <input class="weui-input" id="visitorPhone" type="tel" placeholder="请输入受访人手机号" onBlur="postNP()">
        </div>
    </div>
    <div class="weui-cell">
        <div class="weui-cell__hd"><label for="start-time" class="weui-label">开始时间</label></div>
        <div class="weui-cell__bd">
            <input class="weui-input" id="start-time" type="text" value="" placeholder="">
        </div>
    </div>

    <div class="weui-cell">
        <div class="weui-cell__hd"><label for="hour" class="weui-label">时长/小时</label></div>
        <div class="weui-cell__bd">
            <input class="weui-input" id="hour" type="text" value="">
        </div>
    </div>

    <div class="weui-cell">
        <div class="weui-cell__hd"><label for="reason" class="weui-label">原因</label></div>
        <div class="weui-cell__bd">
            <input class="weui-input" id="reason" type="text" value="">
        </div>
    </div>
    <div class="weui-btn-area">
        <a class="weui-btn weui-btn_primary" href="javascript:" id="showTooltips">发起访问</a>
    </div>

    <div class="weui-tab">
        <div class="weui-navbar">
            <a class="weui-navbar__item weui-bar__item--on">
                常用联系人
            </a>
        </div>
        <div class="weui-tab__bd">
            <div id="tab1" class="weui-tab__bd-item weui-tab__bd-item--active">
                <div class="weui-search-bar" id="searchBar" style="display: none">
                    <form class="weui-search-bar__form" action="#">
                        <div class="weui-search-bar__box"  >
                            <i class="weui-icon-search"></i>
                            <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索"
                                   required="">
                            <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
                        </div>
                        <label class="weui-search-bar__label" id="searchText"
                               style="transform-origin: 0px 0px 0px; opacity: 1; transform: scale(1, 1);">
                            <i class="weui-icon-search"></i>
                            <span>搜索</span>
                        </label>
                    </form>
                    <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
                </div>

                <!-- 联系人列表-->
                <div id="contactPerson"></div>
                <!--<div class="weui-cells">
                    <div class="weui-cell">
                      <div class="weui-cell__hd"><img src=""></div>
                        <div class="weui-cell__bd">
                            <p>data[i].realname</p>
                        </div>
                        <div class="weui-cell__ft">
                            <i onclick="addPersonInfo('personData')">+</i>
                        </div>
                    </div>
                </div>
-->
            </div>


        </div>
    </div>
</div>
<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>
<script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.js"></script>
<script src="js/myUtil.js"></script>
<script>
    function getContacts() {
        $.ajax({
            type: 'POST',
            contentType: "application/x-www-form-urlencoded",
            url: "user/frequentContacts",
            data: {userId: getCookie("userId")},
            success: function (result) {
                console.log(result);
                var data = result.data;
                console.log(data);
                var personSize = result.data.length;
                $("#contactPerson").append("<div class=\"weui-cells\">")
                for (var i in data) {
                    console.log(data[i].id);
                    var realname = data[i].realname;
                    var phone = data[i].phone
                    var visitorid = data[i].id
                    $("#contactPerson").append(" <div class=\"weui-cell\">\n" +
                        "                      <div class=\"weui-cell__hd\"><img src=\"images\\user.png\" style=\"width: 30px;height: 30px\"></div>\n" +
                        "                        <div class=\"weui-cell__bd\">\n" +
                        "                             <p>" + data[i].realname + "</p>\n" +
                        "                        </div>\n" +
                        "                        <div class=\"weui-cell__ft\">\n" +
                        "                           <a href=\"javascript:void(0);\" style=\"font-size:25px;\" onclick=\"addPersonInfo('" + realname + "','" + phone + "','" + visitorid + "')\">+</a>\n" +
                        "                        </div>\n" +
                        "                    </div>")
                }
                $("#contactPerson").append("</div>")
            },
            error: function (e) {
                alert("error" + e.message)
            }
        });
    }

    $(function () {
        if (!isLogin()) {
            if(getCookie("isAuth")!="T"){
                window.location.href=authUrl;
                $.showLoading();
            }else {
                FastClick.attach(document.body);
                $("#start-time").val(formatDateTime(0, 0, 0));
                getContacts();
            }
        }
    });
    $("#start-time").datetimePicker();
    $("#hour").picker({
        title: "请选择拜访时长",
        cols: [
            {
                textAlign: 'center',
                values: ['0.5', '1', '1.5', '2', '2.5', '3', '3.5', '6']
            }
        ],
        onChange: function (p, v, dv) {
            console.log(p, v, dv);
        },
        onClose: function (p, v, d) {
            console.log("close");
        }
    });
    $("#reason").picker({
        title: "请选择拜访原因",
        cols: [
            {
                textAlign: 'center',
                values: ['商务拜访', '配送服务', '面试', '找人', '其他']
            }
        ],
        onChange: function (p, v, dv) {
            console.log(p, v, dv);
        },
        onClose: function (p, v, d) {
            console.log("close");
        }
    });
    $('.weui-cell_swiped').swipeout('open')


    $("#showTooltips").click(function () {
        var isAuth = getCookie("isAuth")
        if (isAuth != "T") {
            $.toptip('请先进行实名认证');
            window.location.href = authUrl;
        } else {
            var tel = $('#visitorPhone').val();
            if (!tel || !/1[3|4|5|7|8]\d{9}/.test(tel)) {
                $.toptip('请输入手机号');
            } else {
                visit();
            }
        }
    });

    //输入完姓名与电话查找visitorId
    function postNP() {
        var visitorName = $("#visitorName").val();
        var visitorPhone = $("#visitorPhone").val();
        if (visitorName == "") {
            $.toptip("拜访姓名不能为空");
            return;
        }
        if (visitorPhone == "") {
            $.toptip("手机号不能为空");
            return;
        }
        $.ajax({
            type: 'POST',
            contentType: "application/x-www-form-urlencoded",
            url: "user/namePhone",
            data: {
                realName: visitorName,
                phone: visitorPhone
            },
            success: function (result) {
                var data = result.data;
                if (result.code == 400) {
                    $.toptip(result.message);
                } else if (result.code == 200) {
                    $("#visitorName").attr("visitorId", data[0].id);
                } else {
                    $.toptip("系统错误");
                }
            }
        });
    }

    //发起成功访问
    function visit() {
        $.showLoading();
        var startDate = $("#start-time").val();
        var hour = $("#hour").val();
        var reason = $("#reason").val();
        $.ajax({
            type: 'POST',
            contentType: "application/x-www-form-urlencoded",
            url: "visit/record/visitRequest",
            data: {
                //从跳转页获取用户id
                userId: getCookie('userId'),
                visitorId: $("#visitorName").attr("visitorId"),
                reason: reason,
                startDate: startDate,
                hour: hour,

            },
            success: function (result) {
                $.hideLoading();
                if (result.code == 400) {
                    $.toptip(result.message);
                } else if (result.code == 200) {
                    $.toast("发起访问成功", 'success');
                    alert("发起访问成功，对方同意后将在《朋悦比邻》公众号提示，请注意查收！");
                    location.reload();
                } else {
                    $.toptip("系统错误");
                }
            }
        });

    }

    function formatDateTime(year, day, hours) {
        var date = new Date();
        var y = date.getFullYear() + year;
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var d = date.getDate() - day;
        d = d < 10 ? ('0' + d) : d;
        var h = date.getHours() + hours;
        h = h < 10 ? ('0' + h) : h;
        var minute = date.getMinutes();
        var second = date.getSeconds();
        minute = minute < 10 ? ('0' + minute) : minute;
        // second = second < 10 ? ('0' + second) : second;

        return y + '-' + m + '-' + d + ' ' + h + ':' + minute;
        //2017-12-12 12:23:34
    }

    function addPersonInfo(name, phone, visitorId) {
        $("#visitorName").val(name);
        $("#visitorPhone").val(phone);
        $("#visitorName").attr("visitorId", visitorId);
    }
</script>
</body>
</html>
